/*!
 * Copyright (c) 2021-2024 WeatherLayers.com
 *
 * WeatherLayers Cloud Client 2024.2.0
 *
 * A valid access token is required to use the library. Contact support@weatherlayers.com for details.
 *
 * Homepage - https://weatherlayers.com/
 * Demo - https://demo.weatherlayers.com/
 * Docs - https://docs.weatherlayers.com/
 * WeatherLayers Cloud Terms of Use - https://weatherlayers.com/terms-of-use.html
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("geotiff")):"function"==typeof define&&define.amd?define(["exports","geotiff"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).WeatherLayersClient={},t.GeoTIFF)}(this,(function(t,e){"use strict";function a(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(a){if("default"!==a){var n=Object.getOwnPropertyDescriptor(t,a);Object.defineProperty(e,a,n.get?n:{enumerable:!0,get:function(){return t[a]}})}})),e.default=t,Object.freeze(e)}var n=a(e);function i(t,e,a,n){if("a"===a&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===a?n:"a"===a?n.call(t):n?n.value:e.get(t)}function r(t,e,a,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(t,a):i?i.value=a:e.set(t,a),a}"function"==typeof SuppressedError&&SuppressedError;const s=new Map;async function o(t){let e;try{e=await n.fromUrl(t,{allowFullFile:!0,blockSize:Number.MAX_SAFE_INTEGER})}catch(e){throw new Error(`Image ${t} can't be decoded.`,{cause:e})}const a=await e.getImage(0),i=await a.readRasters({interleave:!0});if(!(i instanceof Uint8Array||i instanceof Uint8ClampedArray||i instanceof Float32Array))throw new Error("Unsupported data format");const r=function(t,e){if(null==e)return t;const a=t.slice(0);for(let t=0;t<a.length;t++)Math.abs(a[t]-e)<2*Number.EPSILON&&(a[t]=NaN);return a}(i,a.getGDALNoData());return{data:r,width:a.getWidth(),height:a.getHeight()}}function c(t){return(e,a=s)=>{if(!1===a)return t(e);const n=a.get(e);if(n)return n;const i=t(e);return a.set(e,i),i.then((t=>{a.set(e,t)})),i}}const l=c((t=>{if(t.includes(".png")||t.includes(".webp"))return async function(t){const e=await(await fetch(t)).blob(),a=new Image;a.src=URL.createObjectURL(e);try{await a.decode()}catch(e){throw new Error(`Image ${t} can't be decoded.`,{cause:e})}const n=document.createElement("canvas");n.width=a.width,n.height=a.height;const i=n.getContext("2d");i.drawImage(a,0,0);const r=i.getImageData(0,0,n.width,n.height),{data:s,width:o,height:c}=r;return{data:s,width:o,height:c}}(t);if(t.includes(".tif"))return o(t);throw new Error("Unsupported data format")})),f=c((async t=>(await fetch(t)).json()));function h(t,e,a){if(!e){if(t===a)return 0;throw new Error("Invalid state")}if(a<=t)return 0;if(a>=e)return 1;{const n=new Date(t),i=new Date(e);return(new Date(a).getTime()-n.getTime())/(i.getTime()-n.getTime())}}var u,d,m,w,p,g,y,E,C,T,A,b,I,R,S,v,L,O,P;!function(t){t.METRIC="METRIC",t.IMPERIAL="IMPERIAL",t.NAUTICAL="NAUTICAL"}(u||(u={})),function(t){t.LICENSOR="licensor",t.PRODUCER="producer",t.PROCESSOR="processor",t.HOST="host"}(d||(d={})),function(t){t.LICENSE="license",t.SELF="self",t.ROOT="root",t.PARENT="parent",t.CHILD="child",t.ITEM="item",t.COLLECTION="collection",t.CONFORMANCE="conformance",t.DATA="data",t.SEARCH="search"}(m||(m={})),function(t){t.DATA="data",t.OVERVIEW="overview",t.THUMBNAIL="thumbnail",t.PALETTE="palette"}(w||(w={}));const M=u.METRIC;function $(t,e){const a=t.providers.find((t=>t.roles.includes(d.PRODUCER))),n=t.providers.find((t=>t.roles.includes(d.PROCESSOR)));return[...a?[`<a href="${a.url}"${e?` class="${e}"`:""}>${a.name}</a>`]:[],...n?[`<a href="${n.url}"${e?` class="${e}"`:""}>${n.name}</a>`]:[]].join(" via ")}function k(t,e){const a=t["weatherLayers:units"];return a.find((t=>t.system===e))??a.find((t=>t.system===M))??a[0]}g=new WeakMap,y=new WeakMap,E=new WeakMap,C=new WeakMap,p=new WeakSet,T=function(t,e={}){const a=e.accessToken??i(this,g,"f").accessToken??null,n=new URL(t);return n.searchParams.has("access_token")||null==a||n.searchParams.set("access_token",a),n.searchParams.has("version")||n.searchParams.set("version","2024.2.0"),n.toString()},A=function(t){i(this,E,"f").set(t.id,t)},b=function(t,e){i(this,C,"f").has(t)||i(this,C,"f").set(t,new Map),i(this,C,"f").get(t).set(e.properties.datetime,e)},I=async function(t={}){const e=t.url??i(this,g,"f").url??"https://catalog.weatherlayers.com",a=i(this,p,"m",T).call(this,`${e}/catalog`,t);return await f(a,i(this,y,"f"))},R=async function(t={}){const e=(await i(this,p,"m",I).call(this,t)).links.find((t=>t.rel===m.DATA));if(!e)throw new Error("STAC Catalog data link not found");const a=i(this,p,"m",T).call(this,e.href,t),n=(await f(a,i(this,y,"f"))).collections;for(const t of n)i(this,p,"m",A).call(this,t);return n},S=async function(t,e={}){await i(this,p,"m",R).call(this,e);let a=i(this,E,"f").get(t);if(!a)throw new Error(`STAC Collection ${t} not found`);return i(this,p,"m",A).call(this,a),a},v=async function(t,e={}){const a=await i(this,p,"m",S).call(this,t,e),n=Object.values(a.assets).find((t=>t.roles.includes(w.PALETTE)&&"application/json"===t.type));if(!n)throw new Error(`STAC Collection ${t} palette asset not found`);const r=i(this,p,"m",T).call(this,n.href,i(this,g,"f"));return await f(r,i(this,y,"f"))},L=async function(t,e,a={}){const n=(await i(this,p,"m",I).call(this,a)).links.find((t=>t.rel===m.SEARCH));if(!n)throw new Error("STAC Catalog search link not found");const r=new URL(n.href);r.searchParams.set("collections",t),r.searchParams.set("datetime",function(t){const[e,a]=t;return`${e??".."}/${a??".."}`}(e));const s=i(this,p,"m",T).call(this,r.toString(),a),o=(await f(s,i(this,y,"f"))).features;for(const e of o)i(this,p,"m",b).call(this,t,e);return o},O=async function(t,e,a={}){let n=i(this,C,"f").get(t)?.get(e);if(!n){n=(await i(this,p,"m",L).call(this,t,[e,e],a))[0]}if(!n)throw new Error(`STAC Item ${t}/${e} not found`);return n},P=async function(t,e,a={}){const n=a.dataFormat??i(this,g,"f").dataFormat??"byte.png",r=(await i(this,p,"m",O).call(this,t,e)).assets[`data.${n}`];if(!r)throw new Error(`STAC Item ${t}/${e} data asset not found`);const s=i(this,p,"m",T).call(this,r.href,i(this,g,"f"));return l(s,i(this,y,"f"))},t.Client=class{constructor(t){p.add(this),g.set(this,void 0),y.set(this,new Map),E.set(this,new Map),C.set(this,new Map),r(this,g,t,"f")}getConfig(){return{...i(this,g,"f")}}setConfig(t){r(this,g,t,"f")}updateConfig(t){this.setConfig({...i(this,g,"f"),...t})}async loadCatalog(t={}){return(await i(this,p,"m",R).call(this,t)).map((t=>t.id))}async loadDataset(t,e={}){const a=await i(this,p,"m",S).call(this,t,e),n=e.unitSystem??i(this,g,"f").unitSystem??M,r=e.attributionLinkClass??i(this,g,"f").attributionLinkClass??"";return{title:a.title,unitFormat:k(a,n),attribution:$(a,r),datetimeRange:a.extent.temporal.interval[0],datetimes:a.links.filter((t=>t.rel===m.ITEM)).map((t=>t.datetime)).filter((t=>!!t)),palette:await i(this,p,"m",v).call(this,t)}}async loadDatasetSlice(t,e,a={}){return{datetimes:(await i(this,p,"m",L).call(this,t,e,a)).map((t=>t.properties.datetime))}}async loadDatasetData(t,e,a={}){const n=a.datetimeInterpolate??i(this,g,"f").datetimeInterpolate??!1,r=await i(this,p,"m",S).call(this,t,a),s=Array.from(i(this,C,"f").get(t)?.values()??[]).map((t=>t.properties.datetime)).sort(),o=function(t,e){return[...t].reverse().find((t=>t<=e))}(s,e),c=function(t,e){return t.find((t=>t>=e))}(s,e);let l,f;n&&o&&c&&o!==c?(l=o,f=c):(l=e,f=null);const[u,d]=await Promise.all([i(this,p,"m",P).call(this,t,l,a),n&&f?i(this,p,"m",P).call(this,t,f,a):null]);return{image:u,image2:d,imageWeight:n&&f?h(l,f,e):0,imageType:r["weatherLayers:imageType"],imageUnscale:u.data instanceof Uint8Array||u.data instanceof Uint8ClampedArray?r["weatherLayers:imageUnscale"]:null,bounds:r.extent.spatial.bbox[0]}}}}));
//# sourceMappingURL=weatherlayers-client.umd.min.js.map
